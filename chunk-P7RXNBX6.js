import{b as T}from"./chunk-XN64DOPG.js";import{Fa as u,H as C,M as b,O as S,T as p,ca as m,ga as g,i as v,l,p as y,rb as k,u as d,w as f}from"./chunk-56RWGN7N.js";var w=class s{http=p(T);sockets=new Map;priceSubjects=new Map;tickerCache=new Map;reconnectAttempts=new Map;MAX_RECONNECT_ATTEMPTS=5;RECONNECT_DELAY=3e3;popularCryptos=["BTCUSDT","ETHUSDT","BNBUSDT"];connect(e){let t=e.toLowerCase();if(this.priceSubjects.has(t))return this.priceSubjects.get(t).asObservable();let r=new v(0);return this.priceSubjects.set(t,r),this.reconnectAttempts.set(t,0),this.createWebSocket(t,r),r.asObservable()}createWebSocket(e,t){let r=this.sockets.get(e);r&&r.readyState!==WebSocket.CLOSED&&r.close();let n=new WebSocket(`wss://stream.binance.com:9443/ws/${e}@trade`);n.onopen=()=>{console.log(`WebSocket connected for ${e}`),this.reconnectAttempts.set(e,0)},n.onmessage=o=>{try{let i=JSON.parse(o.data),a=parseFloat(i.p);!isNaN(a)&&a>0&&t.next(a)}catch(i){console.error(`Error parsing WebSocket message for ${e}:`,i)}},n.onerror=o=>{console.error(`WebSocket error for ${e}:`,o)},n.onclose=o=>{console.log(`WebSocket closed for ${e}`,o.code,o.reason);let i=this.reconnectAttempts.get(e)||0;i<this.MAX_RECONNECT_ATTEMPTS&&this.priceSubjects.has(e)?(console.log(`Attempting to reconnect ${e} (attempt ${i+1}/${this.MAX_RECONNECT_ATTEMPTS})`),this.reconnectAttempts.set(e,i+1),d(this.RECONNECT_DELAY).subscribe(()=>{this.priceSubjects.has(e)&&this.createWebSocket(e,t)})):i>=this.MAX_RECONNECT_ATTEMPTS&&(console.error(`Max reconnection attempts reached for ${e}`),t.error(new Error("WebSocket connection failed after multiple attempts")))},this.sockets.set(e,n)}disconnect(e){let t=e.toLowerCase();this.reconnectAttempts.delete(t);let r=this.sockets.get(t);r&&((r.readyState===WebSocket.OPEN||r.readyState===WebSocket.CONNECTING)&&r.close(1e3,"Client disconnect"),this.sockets.delete(t));let n=this.priceSubjects.get(t);n&&(n.complete(),this.priceSubjects.delete(t))}getTicker(e){let t=e.toUpperCase();if(this.tickerCache.has(t))return this.tickerCache.get(t);let r=this.http.get(`https://api.binance.com/api/v3/ticker/24hr?symbol=${t}`).pipe(f(n=>{throw console.error(`Error fetching ticker for ${t}:`,n),this.tickerCache.delete(t),n}),C({bufferSize:1,refCount:!0,windowTime:5e3}));return this.tickerCache.set(t,r),d(5e3).subscribe(()=>{this.tickerCache.delete(t)}),r}searchCryptos(e){return!e||e.trim().length===0?l([]):this.http.get("https://api.binance.com/api/v3/exchangeInfo").pipe(y(t=>!t||!t.symbols?[]:t.symbols.filter(r=>r.symbol.includes(e.toUpperCase())&&r.quoteAsset==="USDT"&&r.status==="TRADING").map(r=>r.symbol).slice(0,10)),f(t=>(console.error("Error searching cryptos:",t),l([]))))}disconnectAll(){console.log("Disconnecting all WebSocket connections"),this.reconnectAttempts.clear(),this.sockets.forEach((e,t)=>{(e.readyState===WebSocket.OPEN||e.readyState===WebSocket.CONNECTING)&&e.close(1e3,"Service shutdown")}),this.priceSubjects.forEach(e=>{e.complete()}),this.sockets.clear(),this.priceSubjects.clear(),this.tickerCache.clear()}getConnectionStatus(){let e=new Map,t=["CONNECTING","OPEN","CLOSING","CLOSED"];return this.sockets.forEach((r,n)=>{e.set(n,t[r.readyState]||"UNKNOWN")}),e}static \u0275fac=function(t){return new(t||s)};static \u0275prov=S({token:s,factory:s.\u0275fac,providedIn:"root"})};var E=class s{transform(e){if(e==null)return"-";let t=typeof e=="string"?parseFloat(e):e;return isNaN(t)?"-":t<.01?t.toFixed(8):t<1?t.toFixed(6):t<10?t.toFixed(4):t.toFixed(2)}static \u0275fac=function(t){return new(t||s)};static \u0275pipe=u({name:"cryptoPrice",type:s,pure:!0})};var D=class s{transform(e,t=!0){if(e==null)return"-";let r=typeof e=="string"?parseFloat(e):e;if(isNaN(r))return"-";let n=r.toFixed(2);return t&&r>0?"+"+n+"%":n+"%"}static \u0275fac=function(t){return new(t||s)};static \u0275pipe=u({name:"cryptoPercent",type:s,pure:!0})};var N=class s{transform(e){return e?e.replace("USDT","/USDT").replace("USDC","/USDC").replace("BUSD","/BUSD"):""}static \u0275fac=function(t){return new(t||s)};static \u0275pipe=u({name:"cryptoSymbol",type:s,pure:!0})};function Q(s,e){let r=!e?.manualCleanup?e?.injector?.get(m)??p(m):null,n=x(e?.equal),o;e?.requireSync?o=g({kind:0},{equal:n}):o=g({kind:1,value:e?.initialValue},{equal:n});let i,a=s.subscribe({next:c=>o.set({kind:1,value:c}),error:c=>{o.set({kind:2,error:c}),i?.()},complete:()=>{i?.()}});if(e?.requireSync&&o().kind===0)throw new b(601,!1);return i=r?.onDestroy(a.unsubscribe.bind(a)),k(()=>{let c=o();switch(c.kind){case 1:return c.value;case 2:throw c.error;case 0:throw new b(601,!1)}},{equal:e?.equal})}function x(s=Object.is){return(e,t)=>e.kind===1&&t.kind===1&&s(e.value,t.value)}export{w as a,E as b,D as c,N as d,Q as e};
